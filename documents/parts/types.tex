% types.tex (consolidated) --------------------------------------------------
% Single authoritative data + rendering layer (expl3)
% Features:
%  * Structured storage: personal, experiences, projects, education, skills
%  * Unified date utilities: months -> human friendly, start/end -> range+duration
%  * Optional compact mode (activate with \CVCompacttrue before \begin{document})
%  * Central separator macro and consistent card styling
%  * Public API (stable): \CV<Domain>New, \CV<Domain>Set, \CV<Domain>Get, <Domain>sRender
%  * All legacy duplicated code removed

% Guard (prevent double inclusion)
\providecommand\CVTypesLoaded{}\ifdefined\CVTypesLoaded\expandafter\endinput\fi\def\CVTypesLoaded{}

\RequirePackage{expl3}
\RequirePackage{ragged2e}
\RequirePackage{graphicx}
% chktex-file 1 % silence space warnings in expl3 definitions
% chktex-file 8 % silence dash length arithmetic warnings
\ExplSyntaxOn

% ---------------------------------------------------------------------------
% Mode toggle / spacing knobs
\newif\ifCVCompact
\CVCompactfalse

\cs_new:Npn \cv_sp_card_vgap:     {\ifCVCompact 0.12em \else 0.18em \fi} % vertical gap before each card
\cs_new:Npn \cv_sp_inside_par:    {\ifCVCompact 0.06em \else 0.08em \fi} % paragraph skip inside card
\cs_new:Npn \cv_sp_skills_item:   {\ifCVCompact 0.14em \else 0.18em \fi}

% Central mid separator (dot) â€“ customize here
\cs_new:Npn \cv_sep_mid: {~$\cdot$~}

% Layout width (single source of truth)
\newlength\CVContentWidth
\setlength\fboxsep{2.5pt}
\setlength\CVContentWidth{\dimexpr\textwidth-2\fboxsep-4pt\relax}
\setlength\emergencystretch{1em}

% ---------------------------------------------------------------------------
% Date / duration helpers
\cs_new:Npn \cv_month_short:n #1 {\str_case:nnF {#1}{ {01}{Jan}{02}{Feb}{03}{Mar}{04}{Apr}{05}{May}{06}{Jun}{07}{Jul}{08}{Aug}{09}{Sep}{10}{Oct}{11}{Nov}{12}{Dec} }{???}}
\cs_new:Npn \cv_date_year:n  #1 {\str_range:nnn {#1}{1}{4}}
\cs_new:Npn \cv_date_month:n #1 {\str_range:nnn {#1}{6}{7}}

\int_new:N \l__cv_tmp_months_int
\int_new:N \l__cv_tmp_years_int
\int_new:N \l__cv_tmp_remmonths_int
\cs_new:Npn \cv_format_month_count:n #1 {
  \int_set:Nn \l__cv_tmp_months_int {#1}
  \int_set:Nn \l__cv_tmp_years_int { \int_div_truncate:nn {\l__cv_tmp_months_int}{12} }
  \int_set:Nn \l__cv_tmp_remmonths_int { \l__cv_tmp_months_int - 12*\l__cv_tmp_years_int }
  \int_compare:nTF { \l__cv_tmp_years_int > 0 }
    { \int_compare:nTF { \l__cv_tmp_remmonths_int > 0 }
        { \int_use:N \l__cv_tmp_years_int~yr~\int_use:N \l__cv_tmp_remmonths_int~mo }
        { \int_use:N \l__cv_tmp_years_int~yr } }
    { \int_use:N \l__cv_tmp_months_int~mo }
}

\int_new:N \l__cv_range_diff_int
	l_new:N  \l__cv_range_tl
\cs_new_protected:Npn \cv_format_range_with_duration:nnn #1#2#3 { % start end expectedFlag
  	l_clear:N \l__cv_range_tl
  	l_put_right:Nx \l__cv_range_tl {\cv_month_short:n{\cv_date_month:n{#1}}~\cv_date_year:n{#1}~--~\cv_month_short:n{\cv_date_month:n{#2}}~\cv_date_year:n{#2}}
  	l_if_blank:nF {#3} { \tl_put_right:Nn \l__cv_range_tl {~(Exp)} }
  \int_set:Nn \l__cv_range_diff_int { (\cv_date_year:n{#2} - \cv_date_year:n{#1})*12 + (\cv_date_month:n{#2} - \cv_date_month:n{#1}) }
  	l_put_right:Nx \l__cv_range_tl { \cv_sep_mid: \cv_format_month_count:n {\l__cv_range_diff_int} }
  \l__cv_range_tl
}

\cs_new_protected:Npn \cv_maybe_range_duration:nnn #1#2#3 { % start end fallbackOrExpected
  	l_if_blank:nTF {#1} {#3}{
    	l_if_blank:nTF {#2} {#3}{\cv_format_range_with_duration:nnn {#1}{#2}{#3}}
  }
}

% ---------------------------------------------------------------------------
% Personal (simple prop)
\prop_new:N \g__cv_personal_prop
\cs_new_protected:Npn \CVPersonalNew #1 #2 { } % second arg kept for symmetry
\cs_new:Npn \CVPersonalSet #1 #2 #3 { \prop_gput:Nnn \g__cv_personal_prop {#2}{#3} }
\cs_new:Npn \CVPersonalGet #1 { \prop_item:Nn \g__cv_personal_prop {#1} }

% ---------------------------------------------------------------------------
% Experience
\seq_new:N \g__cv_experiences_seq
\cs_new:Npn \CVExperienceNew #1 #2 { \prop_new:c {g__cv_experience_#1_prop} \seq_gput_right:Nn \g__cv_experiences_seq {#1} }
\cs_new:Npn \CVExperienceSet #1 #2 #3 { \prop_gput:cnn {g__cv_experience_#1_prop}{#2}{#3} }
\cs_new:Npn \CVExperienceGet #1 #2 { \prop_item:cn {g__cv_experience_#1_prop}{#2} }
\cs_new:Npn \CVExperiencesRender { \seq_map_inline:Nn \g__cv_experiences_seq { \CV__experience_render:n {##1} } }

% Experience duration resolution: prefer start/end; else months; else literal duration
	l_new:N \l__cv_exp_start_tl
	l_new:N \l__cv_exp_end_tl
	l_new:N \l__cv_exp_expected_tl
	l_new:N \l__cv_exp_months_tl
	l_new:N \l__cv_exp_result_tl
\cs_new_protected:Npn \CVExperienceDurationResolved:n #1 {
  \prop_get:cnN {g__cv_experience_#1_prop}{start} \l__cv_exp_start_tl
  \prop_get:cnN {g__cv_experience_#1_prop}{end}   \l__cv_exp_end_tl
  \prop_get:cnN {g__cv_experience_#1_prop}{expected} \l__cv_exp_expected_tl
  \prop_get:cnN {g__cv_experience_#1_prop}{months} \l__cv_exp_months_tl
  	l_set:Nn \l__cv_exp_result_tl {\CVExperienceGet{#1}{duration}}
  % start/end branch
  	l_if_blank:VTF \l__cv_exp_start_tl { % no start -> maybe months
    	l_if_blank:VTF \l__cv_exp_months_tl { }{ \tl_set:Nx \l__cv_exp_result_tl { \cv_format_month_count:n {\l__cv_exp_months_tl} } }
  }{
    	l_if_blank:VTF \l__cv_exp_end_tl { % start yes, end missing -> fallback to literal or months
      	l_if_blank:VTF \l__cv_exp_months_tl { }{ \tl_set:Nx \l__cv_exp_result_tl { \cv_format_month_count:n {\l__cv_exp_months_tl} } }
    }{ % have both start and end
      	l_set:Nx \l__cv_exp_result_tl { \cv_format_range_with_duration:nnn {\l__cv_exp_start_tl}{\l__cv_exp_end_tl}{\l__cv_exp_expected_tl} }
    }
  }
  \l__cv_exp_result_tl
}

\cs_new_protected:Npn \CV__experience_render:n #1 {
  \par\vspace{\cv_sp_card_vgap:}
  \noindent\colorbox{backgroundgray}{\parbox{\CVContentWidth}{%
    \RaggedRight\setlength{\parindent}{0pt}\setlength{\parskip}{\cv_sp_inside_par:}%
    {\normalsize\color{headercolor}\textbf{\CVExperienceGet{#1}{company}}}\hfill{\small\color{cvAccentEmbedded}\textbf{\CVExperienceDurationResolved:n{#1}}}\par
    {\normalsize\color{cvAccentLanguages}\textbf{\CVExperienceGet{#1}{title}}}\par
    {\small\color{darktext}\CVExperienceGet{#1}{description}}\par
    \CVExperienceGet{#1}{achievements}%
  }}
}

% ---------------------------------------------------------------------------
% Projects
\seq_new:N \g__cv_projects_seq
\cs_new:Npn \CVProjectNew #1 #2 { \prop_new:c {g__cv_project_#1_prop} \seq_gput_right:Nn \g__cv_projects_seq {#1} }
\cs_new:Npn \CVProjectSet #1 #2 #3 { \prop_gput:cnn {g__cv_project_#1_prop}{#2}{#3} }
\cs_new:Npn \CVProjectGet #1 #2 { \prop_item:cn {g__cv_project_#1_prop}{#2} }
\cs_new:Npn \CVProjectsRender { \seq_map_inline:Nn \g__cv_projects_seq { \CV__project_render:n {##1} } }

\cs_new_protected:Npn \CV__project_render:n #1 {
  \par\vspace{\cv_sp_card_vgap:}
  \noindent\colorbox{backgroundgray}{\parbox{\CVContentWidth}{%
    \RaggedRight\setlength{\parindent}{0pt}\setlength{\parskip}{\cv_sp_inside_par:}%
    {\textbf{\normalsize\color{cvAccentTools}\CVProjectGet{#1}{title}}}\par
    {\small\color{darktext}\CVProjectGet{#1}{description}}\par
    \CVProjectGet{#1}{achievements}%
  }}
}

% ---------------------------------------------------------------------------
% Education
\seq_new:N \g__cv_education_seq
\cs_new:Npn \CVEducationNew #1 #2 { \prop_new:c {g__cv_education_#1_prop} \seq_gput_right:Nn \g__cv_education_seq {#1} }
\cs_new:Npn \CVEducationSet #1 #2 #3 { \prop_gput:cnn {g__cv_education_#1_prop}{#2}{#3} }
\cs_new:Npn \CVEducationGet #1 #2 { \prop_item:cn {g__cv_education_#1_prop}{#2} }
\cs_new:Npn \CVEducationsRender { \seq_map_inline:Nn \g__cv_education_seq { \CV__education_render:n {##1} } }

	l_new:N \l__cv_ed_start_tl
	l_new:N \l__cv_ed_end_tl
	l_new:N \l__cv_ed_expected_tl
\cs_new_protected:Npn \CVEducationRangeResolved:n #1 {
  \prop_get:cnN {g__cv_education_#1_prop}{start} \l__cv_ed_start_tl
  \prop_get:cnN {g__cv_education_#1_prop}{end}   \l__cv_ed_end_tl
  \prop_get:cnN {g__cv_education_#1_prop}{expected} \l__cv_ed_expected_tl
  \cv_maybe_range_duration:nnn {\l__cv_ed_start_tl}{\l__cv_ed_end_tl}{\tl_use:N \l__cv_ed_expected_tl}
}

\cs_new_protected:Npn \CV__education_render:n #1 {
  \par\vspace{\cv_sp_card_vgap:}
  \noindent\colorbox{backgroundgray}{\parbox{\CVContentWidth}{%
    \RaggedRight\setlength{\parindent}{0pt}\setlength{\parskip}{\cv_sp_inside_par:}%
    {\normalsize\color{headercolor}\textbf{\CVEducationGet{#1}{institution}}}\hfill{\small\color{cvAccentEmbedded}\textbf{\CVEducationRangeResolved:n{#1}}}\par
    {\normalsize\color{cvAccentPlatforms}\textbf{\CVEducationGet{#1}{degree}}}\par
    \CVEducationGet{#1}{achievements}%
  }}
}

% ---------------------------------------------------------------------------
% Skills
\prop_new:N \g__cv_skills_prop
\cs_new:Npn \CVSkillsSet #1 #2 { \prop_gput:Nnn \g__cv_skills_prop {#1}{#2} }
\cs_new:Npn \CVSkillsGet #1 { \prop_item:Nn \g__cv_skills_prop {#1} }
\cs_new:Npn \CVSkillsRender {
  \par\vspace{\cv_sp_card_vgap:}
  \noindent\colorbox{backgroundgray}{\parbox{\CVContentWidth}{\RaggedRight\setlength{\parindent}{0pt}\setlength{\parskip}{\cv_sp_inside_par:}%
    \begin{description}[leftmargin=0pt,labelindent=0pt,itemsep=\cv_sp_skills_item:]
      \item[\textcolor{cvAccentLanguages}{\small\textbf{Programming:}}] {\small\CVSkillsGet{languages}}
      \item[\textcolor{cvAccentEmbedded}{\small\textbf{Embedded:}}] {\small\CVSkillsGet{embedded}}
      \item[\textcolor{cvAccentTools}{\small\textbf{Tools:}}] {\small\CVSkillsGet{tools}}
      \item[\textcolor{cvAccentPlatforms}{\small\textbf{Platforms:}}] {\small\CVSkillsGet{platforms}}
      \item[\textcolor{cvAccentCloud}{\small\textbf{Cloud:}}] {\small\CVSkillsGet{cloud}}
      \item[\textcolor{cvAccentOther}{\small\textbf{Other:}}] {\small\CVSkillsGet{other}}
    \end{description}
  }}
}

\ExplSyntaxOff
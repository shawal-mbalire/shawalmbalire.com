# Professional CV Build System
# Enhanced build system with improved organization

# Configuration
CV_NAME = MbalireShawalCV
TEX_FILE = $(CV_NAME).tex
OUTPUT_DIR = output
BUILD_DIR = build
SOURCE_DIR = source
DOCS_DIR = docs
LATEX_CMD = pdflatex -interaction=nonstopmode -halt-on-error -output-directory=$(BUILD_DIR)
PARTS_DIR = parts
ASSETS_DIR = assets

# Create directories if they don't exist
$(shell mkdir -p $(OUTPUT_DIR) $(BUILD_DIR) $(SOURCE_DIR) $(DOCS_DIR))

# Default target builds the complete CV
all: $(OUTPUT_DIR)/$(CV_NAME).pdf

# Standard CV build (current version)
$(OUTPUT_DIR)/$(CV_NAME).pdf: $(TEX_FILE) $(wildcard $(PARTS_DIR)/*.tex)
	@echo "Building professional CV..."
	$(LATEX_CMD) $(TEX_FILE)
	@mv $(BUILD_DIR)/$(CV_NAME).pdf $(OUTPUT_DIR)/
	@echo "‚úÖ CV generated: $(OUTPUT_DIR)/$(CV_NAME).pdf"

# Extended CV with all sections
extended: $(OUTPUT_DIR)/$(CV_NAME)_extended.pdf

$(OUTPUT_DIR)/$(CV_NAME)_extended.pdf: $(wildcard $(PARTS_DIR)/*.tex)
	@echo "Building extended CV with all sections..."
	$(LATEX_CMD) $(CV_NAME)_extended.tex
	@mv $(BUILD_DIR)/$(CV_NAME)_extended.pdf $(OUTPUT_DIR)/
	@echo "‚úÖ Extended CV generated: $(OUTPUT_DIR)/$(CV_NAME)_extended.pdf"

# Professional CV variants for different career focuses
academic: $(OUTPUT_DIR)/$(CV_NAME)_academic.pdf

$(OUTPUT_DIR)/$(CV_NAME)_academic.pdf: $(wildcard $(PARTS_DIR)/*.tex)
	@echo "Building academic-focused CV..."
	@cp $(TEX_FILE) $(BUILD_DIR)/$(CV_NAME)_academic_temp.tex
	@sed -i.bak 's/\\input{parts\/summary}/\\input{parts\/research_summary}/' $(BUILD_DIR)/$(CV_NAME)_academic_temp.tex || true
	$(LATEX_CMD) $(CV_NAME)_academic_temp.tex
	@mv $(BUILD_DIR)/$(CV_NAME)_academic_temp.pdf $(OUTPUT_DIR)/$(CV_NAME)_academic.pdf
	@rm -f $(BUILD_DIR)/$(CV_NAME)_academic_temp.* 
	@echo "‚úÖ Academic CV generated: $(OUTPUT_DIR)/$(CV_NAME)_academic.pdf"

industry: $(OUTPUT_DIR)/$(CV_NAME)_industry.pdf

$(OUTPUT_DIR)/$(CV_NAME)_industry.pdf: $(wildcard $(PARTS_DIR)/*.tex)
	@echo "Building industry-focused CV..."
	@cp $(TEX_FILE) $(BUILD_DIR)/$(CV_NAME)_industry_temp.tex
	@sed -i.bak 's/\\input{parts\/volunteer}/% \\input{parts\/volunteer}/' $(BUILD_DIR)/$(CV_NAME)_industry_temp.tex || true
	$(LATEX_CMD) $(CV_NAME)_industry_temp.tex
	@mv $(BUILD_DIR)/$(CV_NAME)_industry_temp.pdf $(OUTPUT_DIR)/$(CV_NAME)_industry.pdf
	@rm -f $(BUILD_DIR)/$(CV_NAME)_industry_temp.*
	@echo "‚úÖ Industry CV generated: $(OUTPUT_DIR)/$(CV_NAME)_industry.pdf"

startup: $(OUTPUT_DIR)/$(CV_NAME)_startup.pdf

$(OUTPUT_DIR)/$(CV_NAME)_startup.pdf: $(wildcard $(PARTS_DIR)/*.tex)
	@echo "Building startup-focused CV..."
	@cp $(TEX_FILE) $(BUILD_DIR)/$(CV_NAME)_startup_temp.tex
	@sed -i.bak 's/\\input{parts\/certifications}/% \\input{parts\/certifications}/' $(BUILD_DIR)/$(CV_NAME)_startup_temp.tex || true
	$(LATEX_CMD) $(CV_NAME)_startup_temp.tex
	@mv $(BUILD_DIR)/$(CV_NAME)_startup_temp.pdf $(OUTPUT_DIR)/$(CV_NAME)_startup.pdf
	@rm -f $(BUILD_DIR)/$(CV_NAME)_startup_temp.*
	@echo "‚úÖ Startup CV generated: $(OUTPUT_DIR)/$(CV_NAME)_startup.pdf"

# Complete portfolio generation
portfolio: clean
	@echo "üéØ Generating complete CV portfolio..."
	@$(MAKE) all
	@$(MAKE) extended  
	@$(MAKE) academic
	@$(MAKE) industry
	@$(MAKE) startup
	@echo "‚úÖ Portfolio complete: 5 CV variants generated"

# CV comparison report
compare:
	@echo "üìä CV Variants Comparison:"
	@echo "=========================="
	@for file in $(CV_NAME)*.pdf; do \
		if [ -f "$$file" ]; then \
			size=$$(ls -lh "$$file" | awk '{print $$5}'); \
			pages=$$(pdfinfo "$$file" 2>/dev/null | grep Pages | awk '{print $$2}' || echo "?"); \
			echo "üìÑ $$file: $$size, $$pages pages"; \
		fi \
	done

# Quick build for development (no error halt)
quick:
	@echo "Quick build for development..."
	@mkdir -p $(BUILD_DIR)
	pdflatex -interaction=nonstopmode -output-directory=$(BUILD_DIR) $(TEX_FILE)
	@cp $(BUILD_DIR)/$(CV_NAME).pdf $(OUTPUT_DIR)/ 2>/dev/null || true

# Watch mode for development
watch:
	@echo "Starting watch mode (requires fswatch)..."
	@echo "Press Ctrl+C to stop"
	@if command -v fswatch >/dev/null 2>&1; then \
		fswatch -o $(TEX_FILE) $(PARTS_DIR)/ | while read f; do \
			echo "Changes detected, rebuilding..."; \
			$(MAKE) quick; \
		done; \
	else \
		echo "‚ùå fswatch not found. Install with: brew install fswatch"; \
	fi

# Optimize PDF size
optimize: $(OUTPUT_DIR)/$(CV_NAME).pdf
	@echo "Optimizing PDF size..."
	@if command -v gs >/dev/null 2>&1; then \
		gs -sDEVICE=pdfwrite -dCompatibilityLevel=1.4 -dPDFSETTINGS=/screen \
		   -dNOPAUSE -dQUIET -dBATCH -sOutputFile=$(OUTPUT_DIR)/$(CV_NAME)_optimized.pdf $(OUTPUT_DIR)/$(CV_NAME).pdf; \
		echo "‚úÖ Optimized PDF: $(OUTPUT_DIR)/$(CV_NAME)_optimized.pdf"; \
	else \
		echo "‚ùå Ghostscript not found. Install with: brew install ghostscript"; \
	fi

# Show PDF info
info: $(OUTPUT_DIR)/$(CV_NAME).pdf
	@echo "üìÑ CV Information:"
	@echo "File: $(OUTPUT_DIR)/$(CV_NAME).pdf"
	@ls -lh $(OUTPUT_DIR)/$(CV_NAME).pdf | awk '{print "Size: " $$5}'
	@if command -v pdfinfo >/dev/null 2>&1; then \
		pdfinfo $(OUTPUT_DIR)/$(CV_NAME).pdf | grep "Pages\|Creator\|Producer"; \
	fi

# Open PDF in default viewer
view: $(OUTPUT_DIR)/$(CV_NAME).pdf
	@echo "Opening CV in default viewer..."
	@open $(OUTPUT_DIR)/$(CV_NAME).pdf

# Clean build artifacts
clean:
	@echo "Cleaning build artifacts..."
	@rm -f *.aux *.log *.out *.fdb_latexmk *.fls *.synctex.gz *.synctex\(busy\) *.bbl *.blg *.toc

# Clean everything including PDFs
clean-all: clean
	@echo "Removing all generated files..."
	@rm -f $(PDF_FILE) $(CV_NAME)_extended.pdf $(CV_NAME)_academic.pdf $(CV_NAME)_industry.pdf $(CV_NAME)_startup.pdf $(CV_NAME)_optimized.pdf

# Show available targets
help:
	@echo "üìã Available Make Targets:"
	@echo ""
	@echo "üèóÔ∏è  Build Targets:"
	@echo "  all        - Build standard professional CV (default)"
	@echo "  extended   - Build extended CV with all sections"
	@echo "  academic   - Build academic/research-focused CV"
	@echo "  industry   - Build industry/corporate-focused CV" 
	@echo "  startup    - Build startup/entrepreneurial-focused CV"
	@echo "  portfolio  - Generate all CV variants"
	@echo "  quick      - Quick build for development"
	@echo ""
	@echo "üîß Development Tools:"
	@echo "  watch      - Watch files and rebuild automatically"
	@echo "  validate   - Check LaTeX syntax with chktex"
	@echo "  view       - Open PDF in default viewer"
	@echo ""
	@echo "üìä Utilities:"
	@echo "  optimize   - Create size-optimized PDF"
	@echo "  info       - Show PDF information"
	@echo "  compare    - Compare all CV variants"
	@echo ""
	@echo "üßπ Cleanup:"
	@echo "  clean      - Remove build artifacts"
	@echo "  clean-all  - Remove all generated files"
	@echo "  help       - Show this help message"

.PHONY: all extended academic industry startup portfolio compare quick watch optimize validate info view clean clean-all help